using UnityEngine;

public class PlayerFire : MonoBehaviour
{
    public CharacterData _characterData;
    public GameObject bulletPrefab; // Mermi prefab'ý
    public Transform firePoint; // Merminin fýrlatýlacaðý nokta
    float nextFireTime;

    private void Start()
    {
        _characterData = gameObject.GetComponent<Player>().Character;
        GameObject fp = GameObject.FindGameObjectWithTag("FirePoint");
        firePoint = fp.transform;
        bulletPrefab = _characterData.projectilePrefab;
    }

    void Update()
    {
        RotateFirePointToMouse();

        if (Input.GetMouseButton(0) && Time.time >= nextFireTime) // Sol fare tuþu ile ateþ etme
        {
            nextFireTime = Time.time + _characterData.FireRate;
            Shot();
        }
    }

    void RotateFirePointToMouse()
    {
        Vector3 mousePosition = Camera.main.ScreenToWorldPoint(Input.mousePosition);
        mousePosition.z = 0f; // Z eksenini sýfýrla çünkü 2D oyunda Z ekseni kullanýlmaz

        // Oyuncudan fareye olan yönü hesapla
        Vector2 direction = (mousePosition - transform.position).normalized;

        // Fire Point'in yeni pozisyonunu belirle
        firePoint.position = transform.position + (Vector3)direction;

        // Fire Point'i bu yöne döndür
        float angle = Mathf.Atan2(direction.y, direction.x) * Mathf.Rad2Deg;
        firePoint.rotation = Quaternion.Euler(new Vector3(0, 0, angle));
    }

    void Shot()
    {
        Vector3 mousePosition = Camera.main.ScreenToWorldPoint(Input.mousePosition);
        mousePosition.z = 0f; // Z eksenini sýfýrla çünkü 2D oyunda Z ekseni kullanýlmaz

        // Ateþ etme yönünü belirle
        Vector2 direction = (mousePosition - firePoint.position).normalized;

        // Mermiyi oluþtur
        GameObject bullet = Instantiate(bulletPrefab, firePoint.position, firePoint.rotation);

        // Mermiye hýz ve yön ver
        Rigidbody2D rb = bullet.GetComponent<Rigidbody2D>();
        Mermi mer = bullet.GetComponent<Mermi>();
        mer.SetKnockBack(_characterData.KnockBackRate); // Knockback ayarýný yapýlandýr
        rb.velocity = direction * _characterData.FireSpeed; // Mermiyi belirlenen yöne doðru fýrlatmak için
    }
}
